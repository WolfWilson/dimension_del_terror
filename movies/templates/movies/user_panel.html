<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Panel — WolfSight</title>

    <!-- Fuentes / Iconos -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Swiper -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css">

    <!-- Tu CSS -->
    <link rel="stylesheet" href="{% static 'css/user_panel_new.css' %}">
    <link rel="icon" type="image/png" href="{% static 'src/favicon.png' %}">

    <!-- Refuerzo mínimo para no romper layout si el CSS externo falla -->
    <style>
      .movie-poster{display:block;width:100%;height:auto;border-radius:8px}
      .tab-panel{display:none}
      .tab-panel.active{display:block}
      .empty-message{opacity:.75;padding:12px 0}
    </style>
</head>
<body data-theme="dark">

    <main class="user-panel-container">

        <!-- HEADER -->
        <header class="panel-header">
            <div class="user-info">
                <img src="https://via.placeholder.com/80" alt="Avatar de usuario" class="user-avatar">
                <div class="user-details">
                    <h1>Mi Panel</h1>
                    {% if request.user.is_authenticated %}
                        <p>¡Hola, {{ request.user.username }}!</p>
                    {% else %}
                        <p>¡Hola, Invitado!</p>
                    {% endif %}
                </div>
            </div>
            <div class="user-actions">
                <a href="#" class="btn btn-secondary"><i class="fas fa-user-edit"></i> Editar Perfil</a>
                <button class="btn btn-secondary" id="toggleTheme"><i class="fas fa-palette"></i> Tema</button>
                <a href="#" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> Salir</a>
            </div>
        </header>

        <!-- STATS -->
        <section class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-heart stat-icon"></i>
                <div class="stat-info">
                    <span class="stat-label">Favoritos</span>
                    <span class="stat-value">{{ favorite_movies|length }}</span>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-eye stat-icon"></i>
                <div class="stat-info">
                    <span class="stat-label">Por Ver</span>
                    <span class="stat-value">{{ watchlist_movies|length }}</span>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-star stat-icon"></i>
                <div class="stat-info">
                    <span class="stat-label">Valoradas</span>
                    <span class="stat-value">{% if rated_movies %}{{ rated_movies|length }}{% else %}0{% endif %}</span>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-chart-line stat-icon"></i>
                <div class="stat-info">
                    <span class="stat-label">Promedio</span>
                    <span class="stat-value">{% if avg_rating %}{{ avg_rating|floatformat:1 }}{% else %}-{% endif %}</span>
                </div>
            </div>
        </section>

        <!-- FILTROS -->
        <section class="filters-container">
            <form method="get" class="filters-form" action="{% url 'user_panel' %}">
                <div class="search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" name="q" value="{{ request.GET.q }}" placeholder="Buscar en mis listas..." class="search-input">
                </div>
                <select name="genre_id" class="filter-select">
                    <option value="">Todos los géneros</option>
                    {% for g in all_genres %}
                        <option value="{{ g.id }}" {% if request.GET.genre_id == g.id|stringformat:"s" %}selected{% endif %}>{{ g.name }}</option>
                    {% endfor %}
                </select>
                <select name="sort_by" class="filter-select">
                    <option value="recent" {% if request.GET.sort_by == 'recent' %}selected{% endif %}>Ordenar: Recientes</option>
                    <option value="rating" {% if request.GET.sort_by == 'rating' %}selected{% endif %}>Ordenar: Mejor rating</option>
                    <option value="year" {% if request.GET.sort_by == 'year' %}selected{% endif %}>Ordenar: Año</option>
                    <option value="title" {% if request.GET.sort_by == 'title' %}selected{% endif %}>Ordenar: Título (A-Z)</option>
                </select>
                <button type="submit" class="btn btn-primary">Filtrar</button>
                <a class="btn-clean" href="{% url 'user_panel' %}">Limpiar</a>
            </form>
        </section>

        <!-- TABS -->
        <section class="tabs-section">
            <div class="tab-controls" role="tablist" aria-label="Secciones de películas">
                <input type="radio" name="tabset" id="tab-fav" checked>
                <label for="tab-fav" role="tab">Favoritos</label>

                <input type="radio" name="tabset" id="tab-watch">
                <label for="tab-watch" role="tab">Por Ver</label>

                <input type="radio" name="tabset" id="tab-rated">
                <label for="tab-rated" role="tab">Valoradas</label>

                <input type="radio" name="tabset" id="tab-recent">
                <label for="tab-recent" role="tab">Actividad Reciente</label>
            </div>

            <div class="tab-panels">
                <!-- FAVORITOS -->
                <div id="panel-fav" class="tab-panel active">
                    <div class="swiper favorites-carousel">
                        <div class="swiper-wrapper">
                            {% for movie in favorite_movies %}
                            <div class="swiper-slide">
                                <a href="{% url 'movie_detail' movie.id %}">
                                    {% if movie.poster_image %}
                                      <img src="{{ movie.poster_image.url }}" alt="{{ movie.title }}" class="movie-poster">
                                    {% else %}
                                      <img src="{% static 'src/no_poster.jpg' %}" alt="{{ movie.title }}" class="movie-poster">
                                    {% endif %}
                                </a>
                            </div>
                            {% empty %}
                            <div class="empty-message">No tienes películas favoritas todavía.</div>
                            {% endfor %}
                        </div>
                        <!-- Controles ÚNICOS -->
                        <div class="swiper-button-prev fav-prev"></div>
                        <div class="swiper-button-next fav-next"></div>
                    </div>
                </div>

                <!-- POR VER -->
                <div id="panel-watch" class="tab-panel">
                    <div class="swiper watchlist-carousel">
                        <div class="swiper-wrapper">
                            {% for movie in watchlist_movies %}
                            <div class="swiper-slide">
                                <a href="{% url 'movie_detail' movie.id %}">
                                    {% if movie.poster_image %}
                                      <img src="{{ movie.poster_image.url }}" alt="{{ movie.title }}" class="movie-poster">
                                    {% else %}
                                      <img src="{% static 'src/no_poster.jpg' %}" alt="{{ movie.title }}" class="movie-poster">
                                    {% endif %}
                                </a>
                            </div>
                            {% empty %}
                            <div class="empty-message">Tu lista de "Por Ver" está vacía.</div>
                            {% endfor %}
                        </div>
                        <!-- Controles ÚNICOS -->
                        <div class="swiper-button-prev watch-prev"></div>
                        <div class="swiper-button-next watch-next"></div>
                    </div>
                </div>

                <!-- VALORADAS -->
                <div id="panel-rated" class="tab-panel">
                    <div class="rated-movies-grid">
                        {% for movie in rated_movies %}
                        <div class="rated-movie-card">
                            <a href="{% url 'movie_detail' movie.id %}">
                                {% if movie.poster_image %}
                                  <img src="{{ movie.poster_image.url }}" alt="{{ movie.title }}" class="movie-poster">
                                {% else %}
                                  <img src="{% static 'src/no_poster.jpg' %}" alt="{{ movie.title }}" class="movie-poster">
                                {% endif %}
                            </a>
                            <div class="rated-movie-info">
                                <h4 class="rated-movie-title">{{ movie.title }}</h4>
                                {% if movie.user_rating %}
                                <div class="user-rating">
                                    <i class="fas fa-star"></i> {{ movie.user_rating }}/10
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <p class="empty-message">Aún no has valorado ninguna película.</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- ACTIVIDAD -->
                <div id="panel-recent" class="tab-panel">
                    <ul class="activity-list">
                        {% for item in recent_activity %}
                            <li class="activity-item">
                                <div class="activity-icon {{ item.type|lower }}">{{ item.type.0 }}</div>
                                <div class="activity-details">
                                    <p>
                                        Agregaste <a href="{% url 'movie_detail' item.movie.id %}">{{ item.movie.title }}</a> a la lista de '{{ item.type }}'.
                                        {% if item.note %}<span class="activity-note">— {{ item.note }}</span>{% endif %}
                                    </p>
                                    <time datetime="{{ item.date|date:'c' }}">{{ item.date|date:"d M Y, H:i" }}</time>
                                </div>
                            </li>
                        {% empty %}
                            <li class="empty-message">Sin actividad reciente.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </section>

    </main>

    <!-- Swiper -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // 1) Inicializo Swipers con observadores y controles únicos
        const favoritesSwiper = new Swiper('.favorites-carousel', {
          slidesPerView: 'auto',
          spaceBetween: 20,
          observer: true,
          observeParents: true,
          watchOverflow: true,
          navigation: { nextEl: '.fav-next', prevEl: '.fav-prev' },
          breakpoints: {
            320: { slidesPerView: 2, spaceBetween: 15 },
            480: { slidesPerView: 3, spaceBetween: 15 },
            768: { slidesPerView: 5, spaceBetween: 20 },
            1024: { slidesPerView: 7, spaceBetween: 20 },
          }
        });

        const watchlistSwiper = new Swiper('.watchlist-carousel', {
          slidesPerView: 'auto',
          spaceBetween: 20,
          observer: true,
          observeParents: true,
          watchOverflow: true,
          navigation: { nextEl: '.watch-next', prevEl: '.watch-prev' },
          breakpoints: {
            320: { slidesPerView: 2, spaceBetween: 15 },
            480: { slidesPerView: 3, spaceBetween: 15 },
            768: { slidesPerView: 5, spaceBetween: 20 },
            1024: { slidesPerView: 7, spaceBetween: 20 },
          }
        });

        // 2) Tabs robustas: mostrar/ocultar panel + update del carrusel visible
        const panels = {
          fav: document.getElementById('panel-fav'),
          watch: document.getElementById('panel-watch'),
          rated: document.getElementById('panel-rated'),
          recent: document.getElementById('panel-recent'),
        };
        function showPanel(key){
          Object.values(panels).forEach(p => p.classList.remove('active'));
          panels[key].classList.add('active');
          // Forzar recálculo del carrusel visible (evita “pestañeo”)
          if(key === 'fav') favoritesSwiper.update();
          if(key === 'watch') watchlistSwiper.update();
        }
        // Estado inicial (por si CSS no lo aplica a tiempo)
        showPanel('fav');

        document.getElementById('tab-fav').addEventListener('change', () => showPanel('fav'));
        document.getElementById('tab-watch').addEventListener('change', () => showPanel('watch'));
        document.getElementById('tab-rated').addEventListener('change', () => showPanel('rated'));
        document.getElementById('tab-recent').addEventListener('change', () => showPanel('recent'));

        // 3) Toggle de tema
        const btn = document.getElementById('toggleTheme');
        if (btn) {
          const LS_KEY = 'ws_theme';
          const apply = t => document.body.dataset.theme = t;
          apply(localStorage.getItem(LS_KEY) || 'dark');
          btn.addEventListener('click', () => {
            const t = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem(LS_KEY, t);
            apply(t);
          });
        }
      });
    </script>
</body>
</html>
